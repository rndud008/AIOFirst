<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/category.css">
    <title>메인페이지</title>
</head>
<body>
<div id="layout" >
    <div id="layoutLeft" >
        <div onclick="categoryManage()">카테고리관리</div>
        <div onclick="productManage()">상품관리</div>
<!--        <div onclick="memberManage()">회원관리</div>-->
        <div onclick="orderManage()">주문관리</div>
        <div onclick="inquiryManage()">문의내역</div>
<!--        <div onclick="loadFlagMents('statistics','route')">통 계</div>-->
    </div>
    <div id="layoutRight" >

        <th:block th:if="${categoryCheck}" th:fragment="categoryTopContent">
            <th:block  th:insert="views/fragments/category :: categoryManagement"></th:block >
        </th:block>

        <th:block  th:if="${categorySaveForm}" th:fragment="categoryMiddleContent">
            <th:block  th:insert="views/fragments/category :: categorySaveForm"></th:block >
        </th:block >

        <th:block  th:if="${categoryModifyForm}" th:fragment="categoryMiddleContent">
            <th:block  th:insert="views/fragments/category :: categoryModifyForm"></th:block >
        </th:block >

        <th:block  th:if="${categorySearch}" th:fragment="categoryMiddleContent">
            <th:block  th:insert="views/fragments/category :: categorySearch"></th:block >
        </th:block >

        <th:block  th:if="${productCheck}" th:fragment="productTopContent">
            <th:block  th:insert="views/fragments/product :: productManagement"></th:block >
        </th:block >

        <th:block  th:if="${productSaveForm}" th:fragment="productMiddleContent">
            <th:block  th:insert="views/fragments/product :: productSaveForm"></th:block >
        </th:block >

        <th:block  th:if="${productSearch}" th:fragment="productMiddleContent">
            <th:block  th:insert="views/fragments/product :: productSearch"></th:block >
        </th:block >

        <th:block  th:if="${productModifyForm}" th:fragment="productMiddleContent">
            <th:block  th:insert="views/fragments/product :: productModifyForm"></th:block >
        </th:block >

        <th:block  th:if="${productVariantForm}" th:fragment="productMiddleContent">
            <th:block  th:insert="views/fragments/product :: productVariantForm"></th:block >
        </th:block >

        <th:block  th:if="${productSearchAllResult}" th:fragment="productBottomContent">
            <th:block  th:insert="views/fragments/product :: productSearchAllResult"></th:block >
        </th:block >

        <th:block  th:if="${orderCheck}">
            <th:block th:insert="views/fragments/order :: orderManagement"></th:block>
        </th:block >

        <th:block  th:if="${orderDetailCheck}">
            <th:block th:insert="views/fragments/order :: orderDetail"></th:block>
        </th:block >

        <th:block  th:if="${inquiryCheck}">
            <th:block th:insert="views/fragments/inquiry :: inquiryManagement"></th:block>
        </th:block >

        <th:block  th:if="${inquiryDetailCheck}">
            <th:block th:insert="views/fragments/inquiry :: inquiryDetail"></th:block>
        </th:block >

        <th:block  th:if="${inquiryModifyFormCheck}">
            <th:block th:insert="views/fragments/inquiry :: inquiryModifyForm"></th:block>
        </th:block >


    </div>

</div>
</body>

<script  src="/js/api.js"></script>
<script  src="/js/category.js"></script>
<script  src="/js/product.js"></script>

<script>
    const orderManage = () =>{
        window.location.href = '/admin/orders'
    }

    const orderStatusChange = async (button, status ="") =>{

        const div = button.closest('div').parentNode;
        console.log(div)

        const orderId = div.querySelector("input[type='hidden']").value;
        const item ={
            orderId,
            status
        }

        const response = await postJsonResponse(`/api/orders/status`, JSON.stringify(item))

        const data = await response.text();

        if (response.status === 200){

            div.querySelector('#orderStatus').textContent = data
            button.remove()
            alert("변경완료")
        }else {
            alert("잘못된요청입니다.")
        }

    }

    const getOrderList = async (status ="") =>{

        const response = await getResponse(`/api/orders?status=${status}`)

        const data = await response.json();

        if(response.status === 200){
            console.log(data)
            console.log(data.length)
            const ordersDiv = document.getElementById('orders');
            if(data.length === 0){
                ordersDiv.innerHTML =`<div style="display: flex; padding: 10px">주문 내역이 존재하지 않습니다.</div>`
            }else {
                let html = "";

                data.forEach(order =>{
                    html +=
                        `
                        <div style="display: flex; padding: 10px">
                            <input type="hidden" value="${order.orderId}">
                            <div><span>${order.index}</span></div>
                            <div>
                                <a style="display: flex; flex-direction: column" href='/admin/orders/detail/${order.orderId}' >
                                   `
                        order.orderItemDTOS.forEach(orderItem =>{
                            html +=
                                `
                                    <span>
                                        <span>${orderItem.productName}</span>
                                        <span>${orderItem.option}</span>
                                    </span>
                                `
                        })
                    html +=
                        `
                         </a>
                            </div>
                            <div><span >${order.totalPrice}</span></div>
                            <div><span id="orderStatus">${order.status}</span></div>
                            <div><span >${order.createdAt}</span></div>
                            <div>
                             `
                        if(order.itemPending){
                            html += `<button onclick="orderStatusChange(this,'OK')">주문확인</button>`
                        }
                    if(order.adminCheck){
                        html += `<button onclick="orderStatusChange(this,'CANCEL')">주문취소</button>`
                    }
                    html +=
                        `
                        </div>
                        </div>
                        `
                })

                ordersDiv.innerHTML = html;
            }

        }else {
            alert("잘못된 요청입니다.")
        }

    }

    // 문의 내역
    const inquiryManage = () =>{
        window.location.href = '/admin/inquiries'
    }

    const historyBack = () =>{
        history.back();
    }

    const inquiryAnswerSave = async () =>{

        const inquiryId = document.getElementById('inquiry').querySelector('input[type="hidden"]').value;
        const adminContent = document.querySelector('textarea').value;

        const item ={
            inquiryId,
            adminContent
        }

        const response = await postJsonResponse('/api/inquiries/save',JSON.stringify(item));

        if (response.status === 200){
            alert('저장완료')
            window.location.href;
        }else {
            alert('저장실패')
        }

    }

    const inquiryAnswerModifyForm = () =>{
        const inquiryId = document.getElementById('inquiry').querySelector('input[type="hidden"]').value;
        window.location.href = `/admin/inquiries/modifyform/${inquiryId}`
    }

    const inquiryAnswerModify = async () =>{
        const inquiryAnswerId = document.getElementById('inquiryAnswer').querySelector('input[type="hidden"]').value;
        const adminContent = document.querySelector('textarea').value;

        const item ={
            inquiryAnswerId,
            adminContent
        }

        const response = await postJsonResponse('/api/inquiries/modify',JSON.stringify(item));

        if (response.status === 200){
            const data = await response.text();
            console.log(data);
            alert('변경완료')
            window.location.href = `/admin/inquiries/detail/${inquiryAnswerId}`
        }else {
            alert('잘못된요청입니다.')
        }

    }

    const inquiryList = ()=>{
        window.location.href = `/admin/inquiries`
    }

    const noAnswerInquiryList = () =>{
        window.location.href = `/admin/inquiries/noanswer`
    }


</script>

</html>